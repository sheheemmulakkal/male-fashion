
<section class="checkout spad mt-5">
    <div class="container">
        <div class="checkout__form">
            <form action="/place-order" method="post">
                <div>
                <div>
                <div class="row">
                    <div class="col-lg-8 col-md-6">
                    <div class="col-6">
                        <div class="row" style="display: flex ; flex-direction:row; justify-content: space-between;">
                            <h6 style="width: 200px; padding-top: 15px;" lass="checkout__title col-6">Billing Details</h6>
                            <button type="button" onclick="changeAddress()" style="padding: 0; background-color: #111;" class="btn rounded-0 text-white col-6">CHANGE ADDRESS</button>
                        </div>
                        <hr>
                        <div class="row">
                        <div  id="newAddress" <% if ( address || address.length > 0 ) { %> style="display: none;" <% } %> >
                                <div class="checkout__input">
                                    <p >Full Name<span>*</span></p>
                                    <input name="firstName" id="firstName" type="text">
                                </div>
                        
                        <div class="checkout__input">
                            <p>Country<span>*</span></p>
                            <input name="country" id="country" type="text">
                        </div>
                        <div class="checkout__input">
                            <p>Street<span>*</span></p>
                            <input name="street" id="street" type="text" class="checkout__input__add">
                        </div>
                        <div class="checkout__input">
                            <p>Town/City<span>*</span></p>
                            <input name="city" id="city" type="text">
                        </div>
                        <div class="checkout__input">
                            <p>State<span>*</span></p>
                            <input name="state" id="state" type="text">
                        </div>
                        <div class="checkout__input">
                            <p>Postcode / ZIP<span>*</span></p>
                            <input name="pincode" id="pincode" type="number">
                        </div>
                            <div class="checkout__input">
                                <p>Mobile<span>*</span></p>
                                <input name="mobile" id="mobile" type="number">
                            </div>      
                    </div>
                    <% if(address && address.length > 0) { %>
                        <% for (let i = 0; i < address.length; i++) { %>
                            <div id="address-<%= address[i]._id %>" <% if (i !== 0) { %>style="display: none;"<% } %>>
                                <input type="hidden" name="addressId" id="" value="<%= address[i]._id %>">
                              <div class="checkout__input">
                                <p>Full Name<span>*</span></p>
                                <input style="color: #111;" disabled value="<%= address[i].fullName %>" name="fullName" id="firstName" type="text">
                                <input style="color: #111;"  value="<%= address[i].fullName %>" name="fullName" id="firstName" type="hidden">
                              </div>
                              <div class="checkout__input">
                                <p>Street<span>*</span></p>
                                <input style="color: #111;" disabled value="<%= address[i].street %>" name="street" id="street" type="text" class="checkout__input__add">
                                <input style="color: #111;"  value="<%= address[i].street %>" name="street" id="street" type="hidden" class="checkout__input__add">
                              </div>
                              <div class="checkout__input">
                                <p>Town/City<span>*</span></p>
                                <input style="color: #111;" disabled value="<%= address[i].city %>" name="city" id="city" type="text">
                                <input style="color: #111;"  value="<%= address[i].city %>" name="city" id="city" type="hidden">
                              </div>
                              <div class="checkout__input">
                                <p>State<span>*</span></p>
                                <input style="color: #111;" disabled value="<%= address[i].state %>" name="state" id="state" type="text">
                                <input style="color: #111;"  value="<%= address[i].state %>" name="state" id="state" type="hidden">
                              </div>
                              <div class="checkout__input">
                                <p>Postcode / ZIP<span>*</span></p>
                                <input style="color: #111;" disabled value="<%= address[i].pincode %>" name="pincode" id="pincode" type="text">
                                <input style="color: #111;"  value="<%= address[i].pincode %>" name="pincode" id="pincode" type="hidden">
                              </div>
                              <div class="checkout__input">
                                <p>Mobile<span>*</span></p>
                                <input style="color: #111;" disabled value="<%= address[i].mobile %>" name="mobile" id="mobile" type="text">
                                <input style="color: #111;"  value="<%= address[i].mobile %>" name="mobile" id="mobile" type="hidden">
                              </div>
                              </div>
                              <% } %>                          
                              <% } %>
                            </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="checkout__order">
                            <h4 class="order__title">Your order</h4>
                            <div class="checkout__order__products">Product <span>Total</span></div>
                            <ul class="checkout__total__products">
                                <% for( let item of cartAmount[0].items ) { %>
                                <li> <%= item.productName %><span>₹ <%= item.totalPrice %></span></li>
                                <% } %>
                            </ul>
                            <ul class="checkout__total__all">
                                <li>Subtotal <span>₹ <%= cartAmount[0].total %></span></li>
                                <li>Total <span>₹ <%= cartAmount[0].total %></span></li>
                            </ul>

                                <h6 class="mb-1"><b>Payment Method</b></h6>
                                <input type="radio" id="html" name="PaymentMethod" value="COD">
                                <label for="COD">Cash on Delivery</label>

                            <button type="submit" onclick="submitForm()" class="site-btn">PLACE ORDER</button>
                        </div>
                        
                    </div>
                </div>
                </div>
            </form>
        </div>
    </div>
</section>


<div class="modal fade top rounded-0" style="background-color: #000000a2; overflow-y: auto;" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel"
  aria-hidden="true" data-backdrop="true">
  <div class="modal-dialog modal-dialog-centered modal-full-width modal-full-width" role="document">
    <div class="modal-content rounded-0">
      <div class="modal-header bg-success rounded-0">
        <h5 class="modal-title text-white fw-700" id="successModalLabel">Choose address</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        <% if( address && address.length > 0) { %>
            <% for ( let items of address ){ %>
                <div onclick="addAddress('<%= items._id %>')" style="cursor: pointer;"  id="addressdiv-<%= items._id %>" class="row pl-lg-3 address mb-4">
                    <p style="font-weight: 700;" class="pt-2"><%= `${items.fullName}` %>, <br>
                        Mobile : <%=` ${items.mobile}` %> <br>
                        <%= `${items.street}, ${items.village}, ${items.city}, Near ${items.landmark},
                        PIN Code :  ${items.pincode}, ${items.state}` %> </p>
                </div>
                <hr>
            <% } %>
        <% } %>
        <div class="row mt-3 pl-lg-5 address p-1">
            <a onclick="newAddress()" id="addAddressButton" class="btn text-primary fw-bold">Add Address</a>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
    function changeAddress() {
      const bdy = document.body;
      const successModal = document.getElementById("successModal");
    
      // Show the success modal
      successModal.classList.add("show");
      successModal.style.display = "block";
      bdy.style.overflow = "hidden";
    
      // Hide the success modal when clicked anywhere
      successModal.addEventListener("click", () => {
        successModal.classList.remove("show");
        successModal.style.display = "none";
        bdy.style.overflow = "auto";
      });
    }
    
    function addAddress(addressId) {
      const newAddress = document.getElementById("newAddress");
      if (newAddress) {
        newAddress.style.display = "none";
      }
    
      // Hide all addresses
      const addresses = document.querySelectorAll('[id^="address-"]');
      addresses.forEach((address) => {
        address.style.display = "none";
      });
    
      // Show the selected address
      const selectedAddress = document.getElementById(`address-${addressId}`);
      selectedAddress.style.display = "block";
    
      // Enable the input fields in the selected address div
      const inputFields = selectedAddress.querySelectorAll("input");
      inputFields.forEach((input) => {
        input.removeAttribute("disabled");
      });
    }
    
    function newAddress() {
      // Hide all addresses
      const addresses = document.querySelectorAll('[id^="address-"]');
      addresses.forEach((address) => {
        address.style.display = "none";
      });
    
      // Show the newAddress div
      const newAddress = document.getElementById("newAddress");
      newAddress.style.display = "block";
    
      // Enable the input fields in the newAddress div
      const inputFields = newAddress.querySelectorAll("input");
      inputFields.forEach((input) => {
        input.removeAttribute("disabled");
      });
    }
    
    function submitForm() {
  // Get the selected address div
  const selectedAddress = document.querySelector('[id^="address-"]:not([style*="display: none"])');

  // Create a FormData object to collect the form data
  const formData = new FormData(selectedAddress.closest("form"));

  // Get the input values from the selected address div
  const inputFields = selectedAddress.querySelectorAll("input");
  inputFields.forEach((input) => {
    formData.append(input.name, input.value);
  });

  // Submit the form with the FormData
  const form = selectedAddress.closest("form");
  form.action = "/place-order";
  form.method = "post";
  form.submit();
}

    </script>